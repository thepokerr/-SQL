/*Для каждого дня в таблице orders рассчитайте следующие показатели:

Выручку, полученную в этот день.
Суммарную выручку на текущий день.
Прирост выручки, полученной в этот день, относительно значения выручки за предыдущий день.
Колонки с показателями назовите соответственно revenue, total_revenue, revenue_change. Колонку с датами назовите date.*/

select *,
round((revenue-lag(revenue) over(order by date))::decimal/lag(revenue) over(order by date)*100,2) as revenue_change
from
(select date, revenue,
sum(revenue) over(order by date) as total_revenue
from
(select date, sum(price) as revenue from
(select creation_time::date as date, order_id, unnest(product_ids) as prod_ids from orders) as t1
left join products 
on prod_ids = product_id
where order_id not in (select order_id from user_actions where action = 'cancel_order') 
group by date) as t3) t4
order by date
